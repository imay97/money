import telebot
import cherrypy
import psycopg2
from telebot import types
import datetime
import hashlib
import dropbox
import sys
sys.path.append("../")
import dbx
import tlg

WEBHOOK_HOST = '138.68.22.231'
WEBHOOK_PORT = 80 #8443 80 88 443
WEBHOOK_LISTEN = '0.0.0.0'
WEBHOOK_SSL_CERT = '/home/tele/cert/cert.pem'
WEBHOOK_SSL_PRIV = '/home/tele/cert/pkey.key'
WEBHOOK_URL_BASE = 'https://' + str(WEBHOOK_HOST) + ':' + str(WEBHOOK_PORT)
WEBHOOK_URL_PATH = "/%s/" % (API_TOKEN)

bot = telebot.TeleBot(API_TOKEN)

class WebhookServer(object):
    @cherrypy.expose
    def index(self):
        if 'content-length' in cherrypy.request.headers and \
           'content-type' in cherrypy.request.headers and \
           cherrypy.request.headers['content-type'] == 'application/json':
            length = int(cherrypy.request.headers['content-length'])
            json_string = cherrypy.request.body.read(length).decode("utf-8")
            update = telebot.types.Update.de_json(json_string)
            bot.process_new_updates([update])
            return ''
        else:
            raise cherrypy.HTTPError(403)
#begin

conn = psycopg2.connect(dbname='adm', user='adm',
                    password='adm', host='127.0.0.1')

def key_main():
    keyboard = types.ReplyKeyboardMarkup(row_width = 2, resize_keyboard = True)
    btns = []
    btns.append(types.KeyboardButton('ü§ë –ó–∞—Ä–∞–±–æ—Ç–∞—Ç—å'))
    btns.append(types.KeyboardButton('üë• –ü–∞—Ä—Ç–Ω–µ—Ä—ã'))
    btns.append(types.KeyboardButton('üí∞ –ë–∞–ª–∞–Ω—Å'))
    btns.append(types.KeyboardButton('‚ùî –ü–æ–º–æ—â—å'))
    keyboard.add(*btns)
    return keyboard

def key_money():
    keyboard = types.InlineKeyboardMarkup(row_width = 1)
    btns = []
    btns.append(types.InlineKeyboardButton('üó£ –ü—Ä–∏–≥–ª–∞—Å–∏—Ç—å –¥—Ä—É–≥–∞, 200—Ä—É–±', callback_data = "say"))
    btns.append(types.InlineKeyboardButton('üìå –ü–æ–¥–ø–∏—Å–∞—Ç—å—Å—è –Ω–∞ –∫–∞–Ω–∞–ª, 100—Ä—É–±', callback_data = "follow"))
    btns.append(types.InlineKeyboardButton('üëÄ –ü–æ—Å–º–æ—Ç—Ä–µ—Ç—å –∑–∞–ø–∏—Å–∏, 50—Ä—É–±', callback_data = "see"))
    btns.append(types.InlineKeyboardButton('üì± –ú–µ–Ω—é', callback_data = "ok"))
    keyboard.add(*btns)
    return keyboard

def key_admin():
    keyboard = types.InlineKeyboardMarkup()
    btns = []
    btns1 = []
    btns2 = []
    btns.append(types.InlineKeyboardButton('–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞', callback_data = "statistic_qsxcdlewgfwefwfafmag"))
    btns.append(types.InlineKeyboardButton('–†–∞—Å—Å—ã–ª–∫–∞', callback_data = "wefkbamklcsdfdsfhbffwca"))
    btns1.append(types.InlineKeyboardButton('–ó–∞–¥–∞–Ω–∏—è', callback_data = "uhbergubidvskmcxrnladfsbfgb"))
    btns1.append(types.InlineKeyboardButton('–†–µ–∫–ª–∞–º–Ω–∞—è —Ä–µ—Ñ–µ—Ä–∞–ª–∫–∞', callback_data = "123g278hgui34tmdsknladfsbfgb"))
    btns2.append(types.InlineKeyboardButton('–í—ã—Ö–æ–¥', callback_data = "ok"))
    keyboard.add(*btns)
    keyboard.add(*btns1)
    keyboard.add(*btns2)
    return keyboard

def key_exit():
    keyboard = types.InlineKeyboardMarkup()
    btns = []
    btns.append(types.InlineKeyboardButton('–ú–µ–Ω—é', callback_data = "ok"))
    keyboard.add(*btns)
    return keyboard

def key_exit_admin():
    keyboard = types.InlineKeyboardMarkup()
    btns = []
    btns.append(types.InlineKeyboardButton('–ú–µ–Ω—é', callback_data = "ok_admin"))
    keyboard.add(*btns)
    return keyboard

def partners(id, func):
    with conn.cursor() as cur:
        cur.execute('UPDATE users SET active = %s WHERE id = %s', (datetime.datetime.today().strftime('%Y-%m-%d'), id))
        conn.commit()
        try:
            if(func == 1):
                cur.execute('SELECT ref FROM users WHERE id = %s', (id,))
                return 'https://t.me/imaycash_bot?start=' + cur.fetchone()[0]
            if(func == 2):
                cur.execute('SELECT COUNT(id_partners) FROM partners WHERE id_me = %s', (id,))
                n = cur.fetchone()[0]
                return str(n) + '\n–ó–∞—Ä–∞–±–æ—Ç–æ–∫: ' + str(200 * int(n))
        except:
            return 'None'

def mailing(id):
    send('–û—Ç–ø—Ä–∞–≤–ª—å—Ç–µ —Ç–µ–∫—Å—Ç. –ï—Å–ª–∏ —Ç–µ–∫—Å—Ç –Ω–µ –Ω—É–∂–µ–Ω, —Ç–æ –æ—Ç–ø—Ä–∞–≤—å—Ç–µ \'!\'', key_exit_admin(), id)
    with conn.cursor() as cur:
        cur.execute('UPDATE admins SET mod = 1')
        conn.commit()

def mailing_text(id, text):
    if text != '!':
        with open('/home/tele/money/content/text', 'w') as f:
            f.write(text)
        send('–û—Ç–ø—Ä–∞–≤–ª—å—Ç–µ –∫–∞—Ä—Ç–∏–Ω–∫—É, –≤–∏–¥–µ–æ –∏–ª–∏ —Å—Ç–∏–∫. –ï—Å–ª–∏ —ç—Ç–æ–≥–æ –Ω–µ —Ç—Ä–µ–±—É–µ—Ç—Å—è, —Ç–æ –æ—Ç–ø—Ä–∞–≤—å—Ç–µ \'!\'', key_exit_admin(), id)
    with conn.cursor() as cur:
        cur.execute('UPDATE admins SET mod = 2')
        conn.commit()

def send(text, markup, id):
    with conn.cursor() as cur:
        cur.execute('SELECT msg FROM users WHERE id = %s', (id,))
        if bool(cur.rowcount):
            try:
                bot.delete_message(message_id = cur.fetchone()[0], chat_id = id)
            except:
                print('Can\'t delete message')
        if markup != None:
            msg = bot.send_message(id, text, reply_markup = markup)
            cur.execute('UPDATE users SET msg = %s WHERE id = %s', (msg.message_id, id))
            conn.commit()
            return msg.message_id
        else:
            msg = bot.send_message(id, text)
            cur.execute('UPDATE users SET msg = %s WHERE id = %s', (msg.message_id, id))
            conn.commit()
            return msg.message_id
#--------------------------------------------------–æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏------------------------------------------------------------
@bot.message_handler(content_types=['document'])
def handle_docs_photo(message):
    with conn.cursor() as cur:
        cur.execute('SELECT mod FROM admins WHERE id = %s', (message.chat.id,))
        if bool(cur.rowcount):
            mod = cur.fetchone()[0]
            if mod == 2:
                file_info = bot.get_file(message.document.file_id)
                downloaded_file = bot.download_file(file_info.file_path)
                src = '/home/tele/money/content/' + message.document.file_name;
                with open(src, 'wb') as new_file:
                    new_file.write(downloaded_file)
                dbx = dropbox.Dropbox(dbx_token)
                with open(src, 'rb') as f:
                    dbx.files_upload(f.read(), '/' + message.document.file_name)
                text = ''
                with open('/home/tele/money/content/text', 'r') as f:
                    text = f.read()
                print(dbx.files_get_temporary_link('/' + message.document.file_name).link)
                #bot.send_message(message.chat.id, '<a href="' + dbx.files_get_temporary_link(message.document.file_name).link + '">&#8203;</a> %s' % text, parse_mode="HTML")

# file_info = bot.get_file(message.document.file_id)
# downloaded_file = bot.download_file(file_info.file_path)
# src = '/home/tele/money/content/' + message.document.file_name;
# with open(src, 'wb') as new_file:
#     new_file.write(downloaded_file)

# bot.send_media_group(chatid,
# [InputMediaPhoto(msg.message.photo.file_id),
# InputMediaVideo(msg.message.video.file_id)])

# bot.send_message(id, '<a href="IMG_URL">&#8203;</a>',
#                  parse_mode="HTML")

@bot.message_handler(commands = ['admin'])
def admin_panel(message):
    with conn.cursor() as cur:
        cur.execute('SELECT name, pswd FROM admins WHERE id = %s', (message.chat.id,))
        if bool(cur.rowcount):
            row = cur.fetchall()
            name = row[0][0]
            pswd = row[0][1]
            if(pswd == message.text[7:]):
                send('–ó–¥—Ä–∞–≤—Å—Ç–≤—É–π—Ç–µ, ' + str(name).replace('None', '') + '.\n–í—ã –≤–æ—à–ª–∏ –∫–∞–∫ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä', key_admin(), message.chat.id)
            else:
                send('‚ùóÔ∏è‚ùóÔ∏è‚ùóÔ∏è–ù–µ–≤–µ—Ä–Ω—ã–π –ø–∞—Ä–æ–ª—å‚ùóÔ∏è‚ùóÔ∏è‚ùóÔ∏è', key_main(), message.chat.id)
        else:
            send('‚ùóÔ∏è‚ùóÔ∏è‚ùóÔ∏è–£ –í–∞—Å –Ω–µ –¥–æ—Å—Ç—É–ø–∞ –∫ —ç—Ç–æ–º—É —Ä–∞–∑–¥–µ–ª—É. –û –ø–æ–ø—ã—Ç–∫–µ –ø–æ–ª—É—á–µ–Ω–∏—è –ø—Ä–∏–≤–µ–ª–∏–≥–∏—Ä–æ–≤–∞–Ω–Ω–æ–≥–æ –¥–æ—Å—Ç—É–ø–∞ —Å –≤–∞—à–µ–≥–æ –∞–∫–∫–∞—É–Ω—Ç–∞, –±—É–¥–µ—Ç —Å–æ–æ–±—â–µ–Ω–æ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä—É', key_menu(), message.chat.id)

@bot.message_handler(commands = ['start'])  #–ü—Ä–∏ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–∏ –∫ –±–æ—Ç—É –≤—ã–∫–∏–¥—ã–≤–∞—Ç—å MENU
def start(message):
    if message.text[7:] != '':
        with conn.cursor() as cur:
            cur.execute('SELECT id FROM users WHERE id = %s', (message.chat.id,))
            if not bool(cur.rowcount):
                cur.execute('SELECT id FROM users WHERE ref = %s', (message.text[7:],))
                if bool(cur.rowcount):
                    id = cur.fetchone()[0]
                    if(id == message.chat.id):
                        send("–í—ã –Ω–µ –º–æ–∂–µ—Ç–µ –ø—Ä–∏–≥–ª–∞—Å–∏—Ç—å —Å–∞–º–∏ —Å–µ–±—è", key_main(), message.chat.id)
                    else:
                        send("–ü–∞—Ä—Ç–Ω—ë—Ä –ø–µ—Ä–µ—à—ë–ª –ø–æ –≤–∞—à–µ–π —Å—Å—ã–ª–∫–µ", key_main(), id)
                        cur.execute('UPDATE users SET balance = balance + 200 WHERE id = %s', (id,))
                        cur.execute('INSERT INTO partners (id_me, id_partners) VALUES (%s, %s)', (id, message.chat.id))
                        conn.commit()
                else:
                    print('–†–µ—Ñ —Å—Å—ã–ª–∫–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞')
            else:
                print('–ü–∞—Ä—Ç–Ω—ë—Ä —É–∂–µ –ø—Ä–∏–≥–ª–∞—à–µ–Ω')

    with conn.cursor() as cur:
        id = message.chat.id
        cur.execute('SELECT id FROM users WHERE id = %s', (id,))
        if not bool(cur.rowcount):
            msg = bot.send_message(id ,'–ü—Ä–∏–≤–µ—Ç. –Ø –±–æ—Ç –¥–ª—è –∑–∞—Ä–∞–±–∞—Ç—ã–≤–∞–Ω–∏—è –¥–µ–Ω–µ–≥.', reply_markup = key_main())
            hash = hashlib.md5(str(id).encode())
            name = str(message.chat.last_name) + ' ' + str(message.chat.first_name)
            time = str(datetime.datetime.today().strftime('%H.%M.%S'))
            cur.execute('INSERT INTO users (id, name, ref, balance, time, msg) VALUES (%s, %s, %s, 0, %s, %s)', (id, name, str(hash.hexdigest()), time, msg.message_id))
            cur.execute('UPDATE users SET active = %s WHERE id = %s', (datetime.datetime.today().strftime('%Y-%m-%d'), id))
            conn.commit()
        else:
            send("–ú–µ–Ω—é", key_main(), id)
            cur.execute('UPDATE users SET active = %s WHERE id = %s', (datetime.datetime.today().strftime('%Y-%m-%d'), id))
            conn.commit()

@bot.message_handler(content_types=['text'])
def handler(message):
    with conn.cursor() as cur:
        id = message.chat.id
        cur.execute('UPDATE users SET active = %s WHERE id = %s', (datetime.datetime.today().strftime('%Y-%m-%d'), id))
        conn.commit()
        if(message.text == 'ü§ë –ó–∞—Ä–∞–±–æ—Ç–∞—Ç—å'):
            send("–í—ã–±–µ—Ä–∏—Ç–µ —Å–ø–æ—Å–æ–± –∑–∞—Ä–∞–±–æ—Ç–∫–∞", key_money(), id)
        if(message.text == 'üë• –ü–∞—Ä—Ç–Ω–µ—Ä—ã'):
            send('–ü—Ä–∏–≥–ª–∞—à–∞–π—Ç–µ –ø–∞—Ä—Ç–Ω—ë—Ä–æ–≤ –≤ –±–æ—Ç –∏ \
–ø–æ–ª—É—á–∞–π—Ç–µ –∑–∞ –Ω–∏—Ö –¥–µ–Ω—å–≥–∏!\n\
–û—Ç–ø—Ä–∞–≤—å—Ç–µ –¥—Ä—É–≥—É —Å—Å—ã–ª–∫—É –≤ —Ç–µ–ª–µ–≥—Ä–∞–º–µ: \n\
' + partners(id, 1) + '\n\
200 —Ä—É–±. –∑–∞ –∫–∞–∂–¥–æ–≥–æ –ø—Ä–∏–≥–ª–∞—à–µ–Ω–Ω–æ–≥–æ –í–∞–º–∏ –ø–∞—Ä—Ç–Ω–µ—Ä–∞\n\
–ü—Ä–∏–≥–ª–∞—à—ë–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π: ' + partners(id, 2), key_main(), id)
        if(message.text == '‚ùî –ü–æ–º–æ—â—å'):
            send("–í —ç—Ç–æ–º –±–æ—Ç–µ –æ—á–µ–Ω—å –ø—Ä–æ—Å—Ç–∞—è —Å–∏—Å—Ç–µ–º–∞: ‚ôªÔ∏è–∫–∞–Ω–∞–ª—ã —Å–ø–æ–Ω—Å–æ—Ä–æ–≤ –ø–ª–∞—Ç—è—Ç –±–æ—Ç—É –∑–∞ —Ä–µ–∫–ª–∞–º—É, –∞ –±–æ—Ç –ø–ª–∞—Ç–∏—Ç —Ç–µ–±–µ –∑–∞ –ø–æ–¥–ø–∏—Å–∫–∏ –Ω–∞ —ç—Ç–∏ –∫–∞–Ω–∞–ª—ã!\
–í—ã–≤–æ–¥–∏—Ç—å –¥–µ–Ω—å–≥–∏ –∏–∑ –±–æ—Ç–∞ –º–æ–∂–Ω–æ –Ω–∞: –°–±–µ—Ä–±–∞–Ω–∫, Qiwi, –Ø–î–µ–Ω—å–≥–∏, WebMoney –∏ –¥—Ä.\
\
üì£–°–≤–æ–π –æ—Ç–∑—ã–≤ –ø–∏—à–∏ –º–Ω–µ: @xyu_pizda", key_main(), id)
        if(message.text == 'üí∞ –ë–∞–ª–∞–Ω—Å'):
            cur.execute('SELECT balance FROM users WHERE id = %s', (id,))
            send("–í–∞—à –±–∞–ª–∞–Ω—Å: " + str(cur.fetchone()[0]) + " —Ä—É–±\n\
–ú–∏–Ω–∏–º–∞–ª—å–Ω–∞—è —Å—É–º–º–∞ –≤—ã–≤–æ–¥–∞: 3000 —Ä—É–±.", key_main(), id)
        else:
            cur.execute('SELECT mod FROM admins WHERE id = %s', (id,))
            if bool(cur.rowcount):
                mod = cur.fetchone()[0]
                if mod == 1:
                    mailing_text(id, message.text)
                if mod == 2 and message.text == '!':
                    with open('/home/tele/money/content/text', 'r') as f:
                        send(f.read(), None, id)

@bot.callback_query_handler(func = lambda call: True) #–ü—Ä–∏—ë–º CALL_BACK_DATA —Å –∫–Ω–æ–ø–æ–∫
def callback_inline(call):
    id = call.message.chat.id

    if call.data == 'wefkbamklcsdfdsfhbffwca':
        with conn.cursor() as cur:
            cur.execute('SELECT id FROM admins WHERE id = %s', (id,))
            if bool(cur.rowcount):
                mailing(id)

    if call.data == 'statistic_qsxcdlewgfwefwfafmag':
        with conn.cursor() as cur:
            cur.execute('SELECT id FROM admins WHERE id = %s', (id,))
            if bool(cur.rowcount):
                name = cur.fetchone()[0]
                cur.execute('SELECT COUNT(id) FROM users')
                all = cur.fetchone()[0]
                cur.execute('SELECT COUNT(id) FROM users WHERE active - %s <= 7', (datetime.datetime.today().strftime('%Y-%m-%d'),))
                active = cur.fetchone()[0]
                cur.execute('SELECT COUNT(id_partners) FROM partners')
                ref = cur.fetchone()[0]
                send('–í—Å–µ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π: ' + str(all) + '\n\
–ê–∫—Ç–∏–≤–Ω—ã—Ö(–∑–∞ –Ω–µ–¥–µ–ª—é): ' + str(active) + '\n–ü—Ä–∏–≥–ª–∞—à–µ–Ω–Ω—ã—Ö: ' + str(ref) + '\n–†–µ–∫–ª–∞–º–Ω—ã–µ —Å—Å—ã–ª–∫–∏: 0', key_exit_admin(), id)

    if call.data == 'ok_admin':
        with conn.cursor() as cur:
            cur.execute('SELECT name FROM admins WHERE id = %s', (id,))
            if bool(cur.rowcount):
                name = cur.fetchone()[0]
                send('–ó–¥—Ä–∞–≤—Å—Ç–≤—É–π—Ç–µ, ' + name.replace('None', '') + '.\n–í—ã –≤–æ—à–ª–∏ –∫–∞–∫ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä', key_admin(), id)
                cur.execute('UPDATE admins SET mod = 0')
                conn.commit()

    if call.data == 'ok':
        send("–ú–µ–Ω—é", key_main(), id)

    if call.data == 'say':
        send('–ü—Ä–∏–≥–ª–∞—à–∞–π—Ç–µ –ø–∞—Ä—Ç–Ω—ë—Ä–æ–≤ –≤ –±–æ—Ç –∏ \
–ø–æ–ª—É—á–∞–π—Ç–µ –∑–∞ –Ω–∏—Ö –¥–µ–Ω—å–≥–∏!\n\
–û—Ç–ø—Ä–∞–≤—å—Ç–µ –¥—Ä—É–≥—É —Å—Å—ã–ª–∫—É –≤ —Ç–µ–ª–µ–≥—Ä–∞–º–µ: \n\
' + partners(id, 1) + '\n\
200 —Ä—É–±. –∑–∞ –∫–∞–∂–¥–æ–≥–æ –ø—Ä–∏–≥–ª–∞—à–µ–Ω–Ω–æ–≥–æ –í–∞–º–∏ –ø–∞—Ä—Ç–Ω–µ—Ä–∞\n\
–ü—Ä–∏–≥–ª–∞—à—ë–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π: ' + partners(id, 2), key_main(), id)

    if call.data == 'follow':
        send('‚ùå –í—ã –ø–æ–¥–ø–∏—Å–∞–ª–∏—Å—å —É–∂–µ –Ω–∞ –≤—Å–µ –∫–∞–Ω–∞–ª—ã!', key_money(), id)

    if call.data == 'see':
        with conn.cursor() as cur:
            cur.execute('UPDATE users SET active = %s WHERE id = %s', (datetime.datetime.today().strftime('%Y-%m-%d'), id))
            conn.commit()
            cur.execute('SELECT time FROM users WHERE id = %s', (id,))
            now = datetime.datetime.today()
            then = datetime.datetime.strptime(str(cur.fetchone()[0]), '%H.%M.%S')
            delta = now - then
            if(delta.seconds < 3600):
                total = 3600 - delta.seconds
                minutes = (total % 3600) // 60
                seconds = total - (minutes * 60)
                send('–ü—Ä–æ—Å–º–æ—Ç—Ä –∑–∞–ø–∏—Å–µ–π –±—É–¥–µ—Ç –¥–æ—Å—Ç—É–ø–µ–Ω —á–µ—Ä–µ–∑ ' + str(minutes) + ' –º–∏–Ω. ' + str(seconds) + ' —Å–µ–∫.', key_money(), id)
            else:
                cur.execute('UPDATE users SET time = %s WHERE id = %s', (now.strftime('%H.%M.%S'), id))
                conn.commit()
                msg = send('–í—ã–ø–æ–ª–Ω–µ–Ω–æ: 1 –∏–∑ 24', None, id)
                for i in range(25):
                    bot.edit_message_text('–í—ã–ø–æ–ª–µ–Ω–æ: ' + str(i) + ' –∏–∑ 25\n', char_id = id, message_id = msg)
                msg = bot.edit_message_text(text = '–í—ã–ø–æ–ª–µ–Ω–æ: 25 –∏–∑ 25\n–ù–∞—á–∏—Å–ª–µ–Ω–æ: 50 —Ä—É–±.', reply_markup = key_exit(), chat_id = id, message_id = msg.message_id)
                cur.execute('UPDATE users SET balance = balance + 50, msg = %s WHERE id = %s', (msg.mesage_id, id))
                conn.commit()

#end
bot.remove_webhook()
bot.set_webhook(url = WEBHOOK_URL_BASE + WEBHOOK_URL_PATH, certificate = open(WEBHOOK_SSL_CERT, 'r'))

cherrypy.config.update({
    'server.socket_host': WEBHOOK_LISTEN,
    'server.socket_port': WEBHOOK_PORT,
    'server.ssl_module': 'builtin',
    'server.ssl_certificate': WEBHOOK_SSL_CERT,
    'server.ssl_private_key': WEBHOOK_SSL_PRIV
})

cherrypy.quickstart(WebhookServer(), WEBHOOK_URL_PATH, {'/': {}})
